name: Check monthly DLUO and send it to Notion
on:
  # Tous les 1ers du mois à 00:00 UTC
  schedule:
    - cron: '0 0 1 * *'
  # déclenchement manuel si besoin
  workflow_dispatch:

jobs:
  check-dluo:
    runs-on: ubuntu-22.04
    outputs:
      generate-dluo-table-result: ${{ steps.generate-dluo-table.outputs.result }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 22
          cache: 'yarn'
      - run: yarn install --immutable
      - run: git log | head && git status
      - id: compilation
        name: Compile FR
        run: yarn compile:fr
      - id: generate-dluo-table
        name: Generate DLUO table
        run: |
          output=$(node scripts/DLUO/check_DLUO.mjs)
          encoded=$(echo "$output" | base64 | tr -d '\n')
          echo "result=$encoded" >> $GITHUB_OUTPUT

  create-notion-card:
    runs-on: ubuntu-22.04
    needs: check-dluo
    steps:
      - name: Create Notion card
        run: |
          echo "${{ needs.check-dluo.outputs.generate-dluo-table-result }}" | base64 -d > payload_temp.json
          sed "s/NOTION_DATABASE_PLACEHOLDER/${{ secrets.NOTION_DATABASE }}/g" payload_temp.json > payload.json
          curl -X POST "https://api.notion.com/v1/pages" \
          -H "Authorization: Bearer ${{ secrets.NOTION_API_KEY }}" \
          -H "Content-Type: application/json" \
          -H "Notion-Version: 2022-06-28" \
          --data @payload.json
