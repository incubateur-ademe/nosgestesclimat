name: Check monthly DLUO and send it to Notion
on:
  # schedule:
  # Tous les 1ers du mois à 00:00 UTC
  # - cron: '0 0 1 * *'
  workflow_dispatch: # permet aussi de déclencher manuellement si besoin

jobs:
  check-dluo:
    runs-on: ubuntu-22.04
    outputs:
      generate-dluo-calendar-result: ${{ steps.generate-dluo-calendar.outputs.result }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 22
          cache: 'yarn'
      - run: yarn install --immutable
      - run: git log | head && git status
      - id: compilation
        name: Compile FR
        run: yarn compile:fr
      - id: generate-dluo-calendar
        name: Generate DLUO calendar
        run: |
          yarn check:dluo > generate-dluo-calendar.res
          body="$(cat generate-dluo-calendar.res | tail --lines=+3 | head --lines=-1)"
          body="${body//'%'/'%25'}"
          body="${body//$'\n'/'%0A'}"
          body="${body//$'\r'/'%0D'}"
          echo "result=${body}" >> $GITHUB_OUTPUT

  create-notion-card:
    runs-on: ubuntu-22.04
    needs: check-dluo
    steps:
      - name: Create Notion card
        run: |
          curl -X POST "https://api.notion.com/v1/pages" \
          -H "Authorization: Bearer ${{ secrets.NOTION_API_KEY }}" \
          -H "Content-Type: application/json" \
          -H "Notion-Version: 2022-06-28" \
          --data '{
            "parent": { "database_id": "'"${{ secrets.NOTION_DATABASE }}"'" },
            "properties": {
              "Nom": {
                "title": [
                  { "text": { "content": "Carte test - '"$(date +'%Y-%m-%d %H:%M')"'" } }
                ]
              }
            },
            "children": [
              {
                "object": "block",
                "type": "paragraph",
                "paragraph": {
                  "rich_text": [
                    { "type": "text", "text": { "content": "Voici le calendrier - ${{ needs.check-dluo.outputs.generate-dluo-calendar-result }}" } }
                  ]
                }
              }
            ]
          }'
